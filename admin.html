<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√Örshjul ‚Äì Admin</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%2372a3ff'/%3E%3C/svg%3E">
  <style>
    :root{ --bg:#0b1220; --fg:#e6eefc; --muted:#9fb0d3; --card:#101a33; --border:#1e2b4f; --accent:#72a3ff; }
    :root.light{ --bg:#ffffff; --fg:#0b1220; --muted:#52607a; --card:#ffffff; --border:#e5e7eb; --accent:#2b59ff; }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{
      position:sticky; top:0; z-index:30;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:12px;
      padding:12px 16px;
      background:#ffffff !important;
      border-bottom:1px solid #e5e7eb;
      color:#0b1220;
    }
    h1{margin:0; font-size:20px}
    .logo{height:32px; width:auto; display:block}
    @media (max-width:980px){ .logo{height:26px} }

    .wrap{max-width:800px; margin:20px auto; padding:0 16px; display:grid; gap:16px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    input,textarea,button,select{background:color-mix(in hsl, var(--card) 70%, black 10%); color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:10px 12px}
    :root.light input,:root.light textarea,:root.light button,:root.light select{ background:color-mix(in hsl, var(--card) 85%, white 10%) }
    button{cursor:pointer}
    .pill{display:inline-flex; align-items:center; gap:8px; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border)}
    a{color:var(--accent)}
    .hint{color:var(--muted); font-size:12px}
    .ok{color:#5bd6a2}
    .err{color:#ff7a7a}
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--card); font-size:12px; cursor:pointer}
    
    .event-item{border:1px solid var(--border); border-radius:10px; padding:12px; margin:8px 0; cursor:pointer; transition:all 0.2s}
    .event-item:hover{background:color-mix(in hsl, var(--card) 80%, var(--accent) 10%)}
    .event-item.editing{border-color:var(--accent); background:color-mix(in hsl, var(--card) 90%, var(--accent) 5%)}
    .event-title{font-weight:600; margin-bottom:4px}
    .event-meta{font-size:12px; color:var(--muted); display:flex; gap:12px; flex-wrap:wrap}
    .event-actions{margin-top:8px; display:flex; gap:8px}
    .btn-small{padding:4px 8px; font-size:11px; border-radius:6px; cursor:pointer; border:1px solid}
    .btn-edit{background:var(--accent); color:white; border-color:var(--accent)}
    .btn-delete{background:transparent; color:var(--err); border-color:var(--err)}
    .empty-state{text-align:center; padding:40px; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <img class="logo" src="https://karlskoga.se/images/18.17cf90041722ce1749b5e/1640015633047/Karlskoga_liggande.png" alt="Karlskoga kommun">
    <h1>√Örshjul admin ‚Äì Socialf√∂rvaltningen</h1>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
      <label class="pill" style="gap:6px; cursor:pointer">
        <input id="themeSwitch" type="checkbox" />
        <span id="themeLabel">M√∂rkt</span>
      </label>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <h2 style="margin:0 0 8px">Befintliga h√§ndelser</h2>
      <div class="hint">Klicka p√• "Redigera" f√∂r att √§ndra en h√§ndelse eller "Radera" f√∂r att ta bort den.</div>
      <div id="eventsList">
        <div class="empty-state">Laddar h√§ndelser...</div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">Kategorier</h2>
      <div class="hint">Klicka f√∂r att v√§lja en kategori, eller skriv en ny i f√§ltet nedan.</div>
      <div id="catChips" class="chips"></div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px" id="formTitle">L√§gg till h√§ndelse</h2>
      <div class="row" style="grid-template-columns:2fr 1fr">
        <input id="title" placeholder="Titel" />
        <input id="category" list="catlist" placeholder="Kategori (v√§lj eller skriv ny)" />
        <datalist id="catlist"></datalist>
      </div>
      <div class="row3" style="margin-top:10px">
        <input id="start" type="date" />
        <input id="end" type="date" />
        <input id="color" type="color" value="#72a3ff" />
      </div>
      <div class="row" style="margin-top:10px">
        <input id="location" placeholder="Plats (valfritt)" />
        <input id="link" placeholder="L√§nk (valfritt)" />
      </div>
      <textarea id="desc" rows="4" placeholder="Beskrivning (valfritt)" style="margin-top:10px"></textarea>
      <div style="margin-top:10px; display:flex; gap:10px">
        <button id="save"><span id="saveText">Spara h√§ndelse</span></button>
        <button id="clear">T√∂m formul√§r</button>
        <button id="cancel" style="display:none; background:var(--muted)">Avbryt redigering</button>
      </div>
      <div id="msg" class="hint" style="margin-top:10px"></div>
    </section>
  </div>

<script>
// ====== KONFIGURERA DESSA V√ÑRDEN ======
const API_BASE = 'https://script.google.com/macros/s/AKfycbzEoi4hp9OM74MielnvENqA7NdQ8w1XQcsSKqXnfYEYD0vXdYZgOOFyjBC5emlNgVfm/exec';
const TARGET_SHEET = 'Soc';  // √ÑNDRA DETTA f√∂r att styra vilket blad som anv√§nds
const ADMIN_TOKEN = 'Password';  // √ÑNDRA DETTA till din faktiska token
// ==========================================

const el=s=>document.querySelector(s);
let currentEditingId = null;
let allEvents = [];

function initTheme(){
  const saved=localStorage.getItem('theme2')||'dark';
  const root=document.documentElement, sw=el('#themeSwitch'), lbl=el('#themeLabel');
  const isLight=saved==='light'; root.classList.toggle('light',isLight);
  sw.checked=isLight; lbl.textContent=isLight?'Ljust':'M√∂rkt';
  sw.onchange=()=>{const on=sw.checked; root.classList.toggle('light',on); localStorage.setItem('theme2',on?'light':'dark'); lbl.textContent=on?'Ljust':'M√∂rkt';};
}

async function loadEvents(){
  try{
    const url = API_BASE + (API_BASE.includes('?') ? '&' : '?') + `sheet=${TARGET_SHEET}`;
    const res = await fetch(url, {headers: {'Accept': 'application/json'}});
    if(!res.ok) throw new Error('Kunde inte ladda h√§ndelser');
    
    const data = await res.json();
    allEvents = Array.isArray(data) ? data : [];
    
    renderEventsList();
    updateCategories();
    
  } catch(e) {
    console.error('Fel vid laddning av h√§ndelser:', e);
    el('#eventsList').innerHTML = '<div class="empty-state">Kunde inte ladda h√§ndelser</div>';
  }
}

function renderEventsList(){
  const container = el('#eventsList');
  
  if(allEvents.length === 0) {
    container.innerHTML = '<div class="empty-state">Inga h√§ndelser √§nnu. L√§gg till den f√∂rsta!</div>';
    return;
  }
  
  // Sortera efter datum
  const sorted = [...allEvents].sort((a,b) => a.start_date.localeCompare(b.start_date));
  
  container.innerHTML = sorted.map(event => {
    const isEditing = currentEditingId === event.id;
    return `
      <div class="event-item ${isEditing ? 'editing' : ''}" data-id="${event.id}">
        <div class="event-title">${event.title || 'Ingen titel'}</div>
        <div class="event-meta">
          <span>üìÖ ${formatDate(event.start_date)}${event.end_date && event.end_date !== event.start_date ? ' ‚Äì ' + formatDate(event.end_date) : ''}</span>
          ${event.category ? `<span>üè∑Ô∏è ${event.category}</span>` : ''}
          ${event.location ? `<span>üìç ${event.location}</span>` : ''}
        </div>
        ${event.description ? `<div style="margin-top:6px; font-size:13px; color:var(--muted)">${event.description}</div>` : ''}
        <div class="event-actions">
          <button class="btn-small btn-edit" onclick="editEvent('${event.id}')">Redigera</button>
          <button class="btn-small btn-delete" onclick="deleteEvent('${event.id}', '${(event.title || '').replace(/'/g, '\\\')}')">Radera</button>
        </div>
      </div>
    `;
  }).join('');
}

function formatDate(dateStr) {
  if(!dateStr) return '';
  try {
    const date = new Date(dateStr + 'T12:00:00');
    return date.toLocaleDateString('sv-SE', { 
      month: 'short', 
      day: 'numeric',
      year: 'numeric'
    });
  } catch(e) {
    return dateStr;
  }
}

function updateCategories(){
  const cats = [...new Set(allEvents.map(e => e.category).filter(Boolean))].sort();
  
  const dl = el('#catlist'); 
  dl.innerHTML = cats.map(c => `<option value="${c}"></option>`).join('');
  
  const chips = el('#catChips'); 
  chips.innerHTML = '';
  cats.forEach(c => {
    const span = document.createElement('span'); 
    span.className = 'chip'; 
    span.textContent = c;
    span.onclick = () => { el('#category').value = c; };
    chips.appendChild(span);
  });
}

function editEvent(eventId) {
  const event = allEvents.find(e => e.id === eventId);
  if(!event) return;
  
  currentEditingId = eventId;
  
  // Fyll formul√§ret
  el('#title').value = event.title || '';
  el('#category').value = event.category || '';
  el('#start').value = event.start_date || '';
  el('#end').value = event.end_date || '';
  el('#color').value = event.color || '#72a3ff';
  el('#location').value = event.location || '';
  el('#link').value = event.link || '';
  el('#desc').value = event.description || '';
  
  // Uppdatera UI
  el('#formTitle').textContent = 'Redigera h√§ndelse';
  el('#saveText').textContent = 'Uppdatera h√§ndelse';
  el('#cancel').style.display = 'inline-block';
  
  // Uppdatera listan f√∂r att visa vald h√§ndelse
  renderEventsList();
  
  // Scrolla till formul√§ret
  el('#formTitle').scrollIntoView({behavior: 'smooth'});
}

function cancelEdit() {
  currentEditingId = null;
  el('#formTitle').textContent = 'L√§gg till h√§ndelse';
  el('#saveText').textContent = 'Spara h√§ndelse';
  el('#cancel').style.display = 'none';
  
  clearForm();
  renderEventsList();
}

function clearForm() {
  ['title','desc','start','end','link','location','category'].forEach(i => el('#'+i).value = ''); 
  el('#color').value = '#72a3ff';
}

async function deleteEvent(eventId, eventTitle) {
  if(!confirm(`√Ñr du s√§ker p√• att du vill radera "${eventTitle}"?`)) return;
  
  const msg = el('#msg');
  msg.innerHTML = 'Raderar...';
  
  try {
    const payload = {
      action: 'delete',
      token: ADMIN_TOKEN,
      sheet: TARGET_SHEET,
      id: eventId
    };
    
    const body = new URLSearchParams(payload);
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'},
      body
    });
    
    const text = await res.text(); 
    const j = JSON.parse(text);
    
    if(!res.ok || j.error) throw new Error(j.error || res.status);
    
    msg.innerHTML = '<span class="ok">H√§ndelse raderad ‚úî</span>';
    
    // Ladda om h√§ndelser
    setTimeout(() => {
      loadEvents();
      msg.innerHTML = '';
    }, 1500);
    
  } catch(e) {
    msg.innerHTML = '<span class="err">Fel vid radering: ' + e.message + '</span>';
  }
}

function fmtDate(d){const y=d.getUTCFullYear();const m=String(d.getUTCMonth()+1).padStart(2,'0');const da=String(d.getUTCDate()).padStart(2,'0');return `${y}-${m}-${da}`;}
function parseDate(str){ const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(str); if(!m) return null; return new Date(Date.UTC(+m[1],+m[2]-1,+m[3],12,0,0)); }
function normalizeEnd(startStr,endStr){
  const s=parseDate(startStr); let e=parseDate(endStr);
  if(!s || !e) return endStr;
  while(e<=s){ e.setUTCFullYear(e.getUTCFullYear()+1); }
  return fmtDate(e);
}

async function saveEvent(){
  const msg=el('#msg');

  let start=el('#start').value.trim();
  let end=(el('#end').value||'').trim();
  if(end && start && parseDate(end) && parseDate(start) && parseDate(end) <= parseDate(start)){
    end = normalizeEnd(start,end);
  }

  const payload={
    action:'upsert',
    token:ADMIN_TOKEN,
    sheet:TARGET_SHEET,
    id: currentEditingId || Math.random().toString(36).slice(2,10),
    title:el('#title').value.trim(),
    description:el('#desc').value.trim(),
    start_date:start,
    end_date:end,
    category:el('#category').value.trim() || '',
    color:el('#color').value || '',
    link:el('#link').value.trim() || '',
    location:el('#location').value.trim() || ''
  };

  if(!payload.title || !payload.start_date){ 
    msg.innerHTML='<span class="err">Titel och startdatum kr√§vs</span>'; 
    return; 
  }

  msg.innerHTML = currentEditingId ? 'Uppdaterar...' : 'Sparar...';

  try{
    const body=new URLSearchParams(payload);
    const res=await fetch(API_BASE,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body});
    const text=await res.text(); 
    const j=JSON.parse(text);
    
    if(!res.ok || j.error) throw new Error(j.error||res.status);
    
    msg.innerHTML = currentEditingId ? '<span class="ok">H√§ndelse uppdaterad ‚úî</span>' : '<span class="ok">H√§ndelse sparad ‚úî</span>';
    
    // √Öterst√§ll formul√§r
    if(currentEditingId) {
      cancelEdit();
    } else {
      clearForm();
    }
    
    // Ladda om h√§ndelser
    setTimeout(() => {
      loadEvents();
      msg.innerHTML = '';
    }, 1500);
    
  }catch(e){
    msg.innerHTML='<span class="err">Fel vid sparning: '+e.message+'</span>';
  }
}

window.addEventListener('DOMContentLoaded',()=>{
  initTheme();
  
  el('#save').onclick = saveEvent;
  el('#clear').onclick = clearForm;
  el('#cancel').onclick = cancelEdit;

  loadEvents();
});
</script>
</body>
</html>
